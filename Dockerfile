# 1. Базовый образ — лёгкий и быстрый Python 3.12
FROM python:3.12-slim AS base

# 2. Рабочая папка внутри контейнера
WORKDIR /app

# 3. Устанавливаем uv (вместо pip, в 10 раз быстрее)
RUN pip install --no-cache-dir uv

# 4. Копируем только файлы зависимостей — это ключ кэша!
#    Если pyproject.toml и uv.lock не меняются — следующие строки берутся из кэша
COPY pyproject.toml uv.lock* ./
COPY dev.py /

# 5. Устанавливаем зависимости в систему (без виртуального окружения)
#    --frozen — не обновляет lock, --no-sync — только продакшн зависимости
RUN uv sync --frozen --no-install-project

# 6. Теперь копируем весь остальной код проекта
COPY . .

# 7. Устанавливаем сам проект в editable режиме (-e) — это и даёт hot-reload!
#    Когда ты меняешь код локально — контейнер видит изменения сразу
RUN uv sync --frozen

# 8. Открываем порт 8000 наружу
EXPOSE 8000

# 9. Команда запуска (uvicorn с reload для разработки)
CMD ["uv", "run", "dev.py"]